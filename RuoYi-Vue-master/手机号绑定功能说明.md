# 手机号绑定功能实现说明

## 功能概述
在用户点击首页"去绑定"时,先检测用户是否绑定手机号。未绑定的情况下不能跳转到房产提交页面,而是弹出手机号绑定弹窗,完成手机号绑定后才能继续操作。

## 实现流程

### 1. 业务流程
```
用户点击"去绑定"
  ↓
检查是否绑定手机号
  ↓
未绑定 → 弹出手机号绑定弹窗
  ↓         ↓
  ↓     输入手机号
  ↓         ↓
  ↓     点击发送验证码(60s间隔)
  ↓         ↓
  ↓     输入验证码
  ↓         ↓
  ↓     确认绑定
  ↓         ↓
  ↓     更新用户表phonenumber
  ↓         ↓
  └─────────┘
      ↓
  跳转到房产提交页面
```

### 2. 文件结构

#### 新增文件:
1. **API接口** - `ruoyi-app/api/user.js`
   - `sendSmsCode()` - 发送验证码
   - `bindPhone()` - 绑定手机号
   - `getUserInfo()` - 获取用户信息
   - `updateUserProfile()` - 更新用户信息

2. **弹窗组件** - `ruoyi-app/components/phone-bind-modal/phone-bind-modal.vue`
   - 手机号输入
   - 验证码输入
   - 60秒倒计时
   - 表单验证
   - 绑定操作

#### 修改文件:
1. **首页** - `ruoyi-app/pages/index.vue`
   - 引入手机号绑定弹窗组件
   - 修改`goAuth()`方法,添加手机号检测逻辑
   - 添加`isPhoneBound()`方法检查绑定状态
   - 添加`onPhoneBindSuccess()`回调处理绑定成功

2. **用户状态管理** - `ruoyi-app/store/modules/user.js`
   - 添加`phonenumber`字段到state
   - 更新`SET_PHONE`mutation同时设置phonenumber

## 组件使用说明

### PhoneBindModal 组件

#### Props
无

#### Events
- `@success` - 绑定成功时触发

#### Methods
- `open()` - 打开弹窗
- `close()` - 关闭弹窗

#### 使用示例
```vue
<template>
  <view>
    <phone-bind-modal ref="phoneBindModal" @success="onBindSuccess" />
    <button @click="$refs.phoneBindModal.open()">绑定手机号</button>
  </view>
</template>

<script>
import PhoneBindModal from '@/components/phone-bind-modal/phone-bind-modal.vue'

export default {
  components: {
    PhoneBindModal
  },
  methods: {
    onBindSuccess() {
      console.log('绑定成功')
      // 执行后续操作
    }
  }
}
</script>
```

## 功能特性

### 1. 手机号验证
- 必填校验
- 格式校验(11位手机号,1开头)
- 实时错误提示

### 2. 验证码功能
- 60秒倒计时
- 倒计时期间禁用发送按钮
- 显示剩余秒数
- 6位验证码校验

### 3. 用户体验
- 弹窗模态框,无法点击遮罩关闭
- 加载状态提示
- 成功/失败提示
- 自动关闭并跳转

### 4. 安全性
- 验证码有效期控制
- 发送间隔限制(60秒)
- 后端验证码校验

## 后端接口要求

### 1. 发送验证码接口
```
POST /system/user/sendCode
Content-Type: application/json

请求参数:
{
  "phone": "13800138000"  // 手机号
}

返回示例:
{
  "code": 200,
  "msg": "发送成功"
}
```

### 2. 绑定手机号接口
```
POST /system/user/bindPhone
Content-Type: application/json

请求参数:
{
  "phone": "13800138000",  // 手机号
  "code": "123456"         // 验证码
}

返回示例:
{
  "code": 200,
  "msg": "绑定成功",
  "data": {
    "userId": 1,
    "phonenumber": "13800138000"
  }
}
```

### 3. 数据库更新
绑定成功后需要更新 `sys_user` 表的 `phonenumber` 字段:
```sql
UPDATE sys_user
SET phonenumber = '13800138000'
WHERE user_id = ?
```

## 状态管理

### Store State
```javascript
{
  phone: '13800138000',        // 手机号
  phonenumber: '13800138000'   // 手机号(兼容字段)
}
```

### Getters
可以通过以下方式获取手机号:
```javascript
this.$store.state.user.phonenumber
// 或
this.$store.state.user.phone
```

## 测试要点

### 1. 手机号输入测试
- [ ] 未输入手机号点击发送验证码
- [ ] 输入错误格式手机号
- [ ] 输入正确格式手机号

### 2. 验证码测试
- [ ] 未输入验证码点击确认绑定
- [ ] 输入错误长度验证码
- [ ] 输入正确验证码
- [ ] 60秒倒计时功能
- [ ] 倒计时结束后重新发送

### 3. 绑定流程测试
- [ ] 首次绑定手机号
- [ ] 已绑定用户不弹出弹窗
- [ ] 绑定成功后跳转
- [ ] 绑定失败错误提示

### 4. 异常情况测试
- [ ] 网络异常
- [ ] 接口返回错误
- [ ] 组件销毁时清理定时器

## 注意事项

1. **验证码有效期**: 后端需要设置验证码有效期(建议5-10分钟)
2. **发送频率限制**: 后端需要限制同一手机号的发送频率
3. **手机号唯一性**: 后端需要校验手机号是否已被其他用户绑定
4. **定时器清理**: 组件销毁时需要清理倒计时定时器
5. **状态同步**: 绑定成功后需要调用`GetInfo`更新用户状态

## 扩展功能

可以根据需求扩展以下功能:
1. 修改手机号功能
2. 手机号解绑功能
3. 短信验证码图形验证码前置
4. 手机号找回密码
5. 手机号登录

## 版本历史

### v1.0.0 (2024-01-20)
- ✅ 手机号绑定基础功能
- ✅ 60秒倒计时
- ✅ 表单验证
- ✅ 与首页集成
- ✅ Store状态管理
