<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.system.mapper.SysMeetingVoteMapper">

    <resultMap type="SysMeetingVote" id="SysMeetingVoteResult">
        <id property="voteId" column="vote_id"/>
        <result property="meetingId" column="meeting_id"/>
        <result property="topicId" column="topic_id"/>
        <result property="userId" column="user_id"/>
        <result property="userName" column="user_name"/>
        <result property="voteOption" column="vote_option"/>
        <result property="voteType" column="vote_type"/>
        <result property="flieUrl" column="flie_url"/>
        <result property="voteNo" column="vote_no"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <select id="findVote" resultMap="SysMeetingVoteResult">
        select * from sys_meeting_vote where user_id = #{userId} and topic_id = #{topicId}
    </select>

    <insert id="insertVote" parameterType="SysMeetingVote">
        insert into sys_meeting_vote(meeting_id, topic_id, user_id, user_name, vote_option, vote_type, flie_url, create_time, update_time)
        values(#{meetingId}, #{topicId}, #{userId}, #{userName}, #{voteOption}, #{voteType}, #{flieUrl}, now(), now())
    </insert>

    <update id="updateVote" parameterType="SysMeetingVote">
        update sys_meeting_vote
        set vote_option = #{voteOption},
            vote_type = #{voteType},
            flie_url = #{flieUrl},
            update_time = now()
        where vote_id = #{voteId}
    </update>

    <select id="selectUserVotesInMeeting" resultMap="SysMeetingVoteResult">
        select topic_id, vote_option from sys_meeting_vote
        where user_id = #{userId} and meeting_id = #{meetingId}
    </select>

    <select id="selectVotesByTopicId" resultMap="SysMeetingVoteResult">
        select * from sys_meeting_vote where topic_id = #{topicId}
    </select>

    <select id="selectSysMeetingVoteByVoteId" parameterType="Long" resultMap="SysMeetingVoteResult">
        select * from sys_meeting_vote where vote_id = #{voteId}
    </select>

    <select id="selectSysMeetingVoteList" parameterType="SysMeetingVote" resultMap="SysMeetingVoteResult">
        select * from sys_meeting_vote
        <where>
            <if test="meetingId != null "> and meeting_id = #{meetingId}</if>
            <if test="topicId != null "> and topic_id = #{topicId}</if>
            <if test="userId != null "> and user_id = #{userId}</if>
            <if test="voteOption != null"> and vote_option = #{voteOption}</if>
            <if test="voteType != null"> and vote_type = #{voteType}</if>
        </where>
    </select>

    <insert id="insertSysMeetingVote" parameterType="SysMeetingVote" useGeneratedKeys="true" keyProperty="voteId">
        insert into sys_meeting_vote
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="meetingId != null">meeting_id,</if>
            <if test="topicId != null">topic_id,</if>
            <if test="userId != null">user_id,</if>
            <if test="userName != null and userName != ''">user_name,</if>
            <if test="voteOption != null">vote_option,</if>
            <if test="voteType != null">vote_type,</if>
            <if test="flieUrl != null and flieUrl != ''">flie_url,</if>
            <if test="voteNo != null and voteNo != ''">vote_no,</if>
            <if test="createTime != null">create_time,</if>
         </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="meetingId != null">#{meetingId},</if>
            <if test="topicId != null">#{topicId},</if>
            <if test="userId != null">#{userId},</if>
            <if test="userName != null and userName != ''">#{userName},</if>
            <if test="voteOption != null">#{voteOption},</if>
            <if test="voteType != null">#{voteType},</if>
            <if test="flieUrl != null and flieUrl != ''">#{flieUrl},</if>
            <if test="voteNo != null and voteNo != ''">#{voteNo},</if>
            <if test="createTime != null">#{createTime},</if>
         </trim>
    </insert>

    <update id="updateSysMeetingVote" parameterType="SysMeetingVote">
        update sys_meeting_vote
        <trim prefix="SET" suffixOverrides=",">
            <if test="meetingId != null">meeting_id = #{meetingId},</if>
            <if test="topicId != null">topic_id = #{topicId},</if>
            <if test="userId != null">user_id = #{userId},</if>
            <if test="userName != null and userName != ''">user_name = #{userName},</if>
            <if test="voteOption != null">vote_option = #{voteOption},</if>
            <if test="voteType != null">vote_type = #{voteType},</if>
            <if test="flieUrl != null and flieUrl != ''">flie_url = #{flieUrl},</if>
            <if test="voteNo != null and voteNo != ''">vote_no = #{voteNo},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
        </trim>
        where vote_id = #{voteId}
    </update>

    <delete id="deleteSysMeetingVoteByVoteIds" parameterType="String">
        delete from sys_meeting_vote where vote_id in 
        <foreach item="voteId" collection="array" open="(" separator="," close=")">
            #{voteId}
        </foreach>
    </delete>
    <!-- 投票记录VO ResultMap -->
    <resultMap type="com.ruoyi.system.domain.vo.VoteRecordVO" id="VoteRecordVOResult">
        <result property="userId" column="user_id"/>
        <result property="ownerId" column="owner_id"/>
        <result property="userName" column="user_name"/>
        <result property="roomNumber" column="room_number"/>
        <result property="area" column="area"/>
        <result property="phonenumber" column="phonenumber"/>
        <result property="voteRightStatus" column="vote_right_status"/>
        <result property="voterStatus" column="voter_status"/>
        <result property="actualVoteRight" column="actual_vote_right"/>
        <result property="participationTime" column="participation_time"/>
        <result property="voteOption" column="vote_option"/>
        <result property="voteType" column="vote_type"/>
        <result property="voteNo" column="vote_no"/>
        <result property="proxyStatus" column="proxy_status"/>
    </resultMap>

    <!-- 查询会议投票记录列表 -->
    <!-- 查询会议投票记录列表 -->
    <select id="selectVoteRecordsList" resultMap="VoteRecordVOResult">
        SELECT 
            eup.user_id,
            op.owner_id,
            u.user_name,
            ep.room_number,
            ep.area,
            COALESCE(op.phonenumber, u.phonenumber) as phonenumber,
            CASE WHEN u.status = '0' THEN '正常' ELSE '冻结' END as vote_right_status,
            CASE WHEN mv.vote_id IS NOT NULL THEN '已投票' ELSE '未参会' END as voter_status,

            ep.area as actual_vote_right,
            mv.create_time as participation_time,
            mv.vote_option,
            mv.vote_type,
            mv.vote_no,
            '' as proxy_status
        FROM 
            sys_estate_user_property eup
        INNER JOIN 
            sys_estate_property ep ON eup.property_id = ep.property_id
        LEFT JOIN 
            sys_user u ON eup.user_id = u.user_id
        LEFT JOIN 
            sys_owner_profile op ON eup.user_id = op.user_id AND eup.community_id = op.community_id
        LEFT JOIN 
            sys_meeting_vote mv ON eup.user_id = mv.user_id AND mv.meeting_id = #{meetingId}
        WHERE 
            eup.community_id = #{communityId}
            AND eup.status = '1'
            AND (eup.del_flag = '0' OR eup.del_flag IS NULL)
            AND (ep.del_flag = '0' OR ep.del_flag IS NULL)
            <if test="userName != null and userName != ''">
                AND (
                    ep.room_number LIKE CONCAT('%', #{userName}, '%')
                    OR op.phonenumber LIKE CONCAT('%', #{userName}, '%')
                    OR u.phonenumber LIKE CONCAT('%', #{userName}, '%')
                    OR u.user_name LIKE CONCAT('%', #{userName}, '%')
                )
            </if>
            <if test="voteStatus != null and voteStatus == '1'">
                AND mv.vote_id IS NOT NULL
            </if>
            <if test="voteStatus != null and voteStatus == '0'">
                AND mv.vote_id IS NULL
            </if>
        ORDER BY 
            ep.room_number
    </select>

    <!-- 表决结果VO ResultMap -->
    <resultMap type="com.ruoyi.system.domain.vo.VoteResultVO" id="VoteResultVOResult">
        <result property="topicId" column="topic_id"/>
        <result property="topicTitle" column="topic_title"/>
        <result property="agreePeople" column="agree_people"/>
        <result property="agreeArea" column="agree_area"/>
        <result property="opposePeople" column="oppose_people"/>
        <result property="opposeArea" column="oppose_area"/>
        <result property="abstainPeople" column="abstain_people"/>
        <result property="abstainArea" column="abstain_area"/>
        <result property="notVotedPeople" column="not_voted_people"/>
        <result property="notVotedArea" column="not_voted_area"/>
        <result property="totalPeople" column="total_people"/>
        <result property="totalArea" column="total_area"/>
        <result property="actualPeople" column="actual_people"/>
        <result property="actualArea" column="actual_area"/>
        <result property="peopleParticipationRate" column="people_participation_rate"/>
        <result property="areaParticipationRate" column="area_participation_rate"/>
        <result property="agreePeopleRate" column="agree_people_rate"/>
        <result property="agreeAreaRate" column="agree_area_rate"/>
        <result property="isPassed" column="is_passed"/>
    </resultMap>

    <!-- 查询会议表决结果统计 -->

    <!-- 投票列表导出VO ResultMap -->
    <resultMap type="com.ruoyi.system.domain.vo.VoteListExportVO" id="VoteListExportVOResult">
        <result property="rowNum" column="row_num"/>
        <result property="roomNumber" column="room_number"/>
        <result property="userName" column="userName"/>
        <result property="phonenumber" column="phonenumber"/>
        <result property="area" column="area"/>
        <result property="voterStatus" column="voter_status"/>
        <result property="participationTime" column="participation_time"/>
        <result property="voteType" column="vote_type"/>
        <result property="topicVotes" column="topic_votes"/>
    </resultMap>

    <!-- 查询投票列表用于Excel导出 -->
    <select id="selectVoteListForExport" resultMap="VoteListExportVOResult">
        SELECT
            ROW_NUMBER() OVER (ORDER BY ep.room_number) as row_num,
            ep.room_number,
            op.user_name,
            COALESCE(op.phonenumber, u.phonenumber) as phonenumber,
            ep.area,
            CASE WHEN mv.vote_id IS NOT NULL THEN '已投票' ELSE '未投票' END as voter_status,
            mv.create_time as participation_time,
            mv.vote_type,
            GROUP_CONCAT(
                CONCAT(t.topic_title, ':',
                    CASE mv2.vote_option
                        WHEN 0 THEN '同意'
                        WHEN 1 THEN '反对'
                        WHEN 2 THEN '弃权'
                        ELSE '未投票'
                    END
                )
                ORDER BY t.order_num SEPARATOR '; '
            ) as topic_votes
        FROM
            sys_estate_user_property eup
        INNER JOIN
            sys_estate_property ep ON eup.property_id = ep.property_id
        LEFT JOIN
            sys_user u ON eup.user_id = u.user_id
        LEFT JOIN
            sys_owner_profile op ON eup.user_id = op.user_id AND eup.community_id = op.community_id
        LEFT JOIN
            (SELECT DISTINCT user_id, meeting_id, vote_id, create_time, vote_type
             FROM sys_meeting_vote WHERE meeting_id = #{meetingId}
             GROUP BY user_id, meeting_id) mv ON eup.user_id = mv.user_id AND mv.meeting_id = #{meetingId}
        LEFT JOIN
            sys_property_meeting_topic t ON t.meeting_id = #{meetingId}
        LEFT JOIN
            sys_meeting_vote mv2 ON mv2.user_id = eup.user_id AND mv2.topic_id = t.topic_id AND mv2.meeting_id = #{meetingId}
        WHERE
            eup.community_id = #{communityId}
            AND eup.status = '1'
            AND (eup.del_flag = '0' OR eup.del_flag IS NULL)
            AND (ep.del_flag = '0' OR ep.del_flag IS NULL)
        GROUP BY
            eup.user_id, ep.room_number, op.user_name, op.phonenumber, u.phonenumber,
            ep.area, mv.vote_id, mv.create_time, mv.vote_type
        ORDER BY
            ep.room_number
    </select>
    <select id="selectVoteResultsByMeeting" resultMap="VoteResultVOResult">
        SELECT 
            t.topic_id,
            t.topic_title,
            -- 同意统计
            COALESCE(agree_stats.people_count, 0) as agree_people,
            COALESCE(agree_stats.area_sum, 0) as agree_area,
            -- 反对统计
            COALESCE(oppose_stats.people_count, 0) as oppose_people,
            COALESCE(oppose_stats.area_sum, 0) as oppose_area,
            -- 弃权统计
            COALESCE(abstain_stats.people_count, 0) as abstain_people,
            COALESCE(abstain_stats.area_sum, 0) as abstain_area,
            -- 总数统计
            total_stats.people_count as total_people,
            total_stats.area_sum as total_area,
            -- 实际投票统计
            COALESCE(voted_stats.people_count, 0) as actual_people,
            COALESCE(voted_stats.area_sum, 0) as actual_area,
            -- 未投票统计
            (total_stats.people_count - COALESCE(voted_stats.people_count, 0)) as not_voted_people,
            (total_stats.area_sum - COALESCE(voted_stats.area_sum, 0)) as not_voted_area,
            -- 参与率
            CASE WHEN total_stats.people_count > 0 
                THEN ROUND(COALESCE(voted_stats.people_count, 0) * 100.0 / total_stats.people_count, 2)
                ELSE 0 END as people_participation_rate,
            CASE WHEN total_stats.area_sum > 0 
                THEN ROUND(COALESCE(voted_stats.area_sum, 0) * 100.0 / total_stats.area_sum, 2)
                ELSE 0 END as area_participation_rate,
            -- 同意占比
            CASE WHEN total_stats.people_count > 0 
                THEN ROUND(COALESCE(agree_stats.people_count, 0) * 100.0 / total_stats.people_count, 2)
                ELSE 0 END as agree_people_rate,
            CASE WHEN total_stats.area_sum > 0 
                THEN ROUND(COALESCE(agree_stats.area_sum, 0) * 100.0 / total_stats.area_sum, 2)
                ELSE 0 END as agree_area_rate,
            -- 是否通过(双过半:同意人数>50% AND 同意面积>50%)
            CASE WHEN (COALESCE(agree_stats.people_count, 0) * 100.0 / total_stats.people_count > 50)
                  AND (COALESCE(agree_stats.area_sum, 0) * 100.0 / total_stats.area_sum > 50)
                THEN 1 ELSE 0 END as is_passed
        FROM 
            sys_property_meeting_topic t
        -- 总数统计(该小区所有已审核用户)
        CROSS JOIN (
            SELECT 
                COUNT(DISTINCT eup.user_id) as people_count,
                COALESCE(SUM(ep.area), 0) as area_sum
            FROM sys_estate_user_property eup
            INNER JOIN sys_estate_property ep ON eup.property_id = ep.property_id
            WHERE eup.community_id = #{communityId}
                AND eup.status = '1'
                AND (eup.del_flag = '0' OR eup.del_flag IS NULL)
                AND (ep.del_flag = '0' OR ep.del_flag IS NULL)
        ) total_stats
        -- 同意票统计
        LEFT JOIN (
            SELECT 
                mv.topic_id,
                COUNT(DISTINCT mv.user_id) as people_count,
                COALESCE(SUM(ep.area), 0) as area_sum
            FROM sys_meeting_vote mv
            INNER JOIN sys_estate_user_property eup ON mv.user_id = eup.user_id
            INNER JOIN sys_estate_property ep ON eup.property_id = ep.property_id
            WHERE mv.meeting_id = #{meetingId}
                AND mv.vote_option = 0
                AND eup.community_id = #{communityId}
                AND eup.status = '1'
                AND (eup.del_flag = '0' OR eup.del_flag IS NULL)
                AND (ep.del_flag = '0' OR ep.del_flag IS NULL)
            GROUP BY mv.topic_id
        ) agree_stats ON t.topic_id = agree_stats.topic_id
        -- 反对票统计
        LEFT JOIN (
            SELECT 
                mv.topic_id,
                COUNT(DISTINCT mv.user_id) as people_count,
                COALESCE(SUM(ep.area), 0) as area_sum
            FROM sys_meeting_vote mv
            INNER JOIN sys_estate_user_property eup ON mv.user_id = eup.user_id
            INNER JOIN sys_estate_property ep ON eup.property_id = ep.property_id
            WHERE mv.meeting_id = #{meetingId}
                AND mv.vote_option = 1
                AND eup.community_id = #{communityId}
                AND eup.status = '1'
                AND (eup.del_flag = '0' OR eup.del_flag IS NULL)
                AND (ep.del_flag = '0' OR ep.del_flag IS NULL)
            GROUP BY mv.topic_id
        ) oppose_stats ON t.topic_id = oppose_stats.topic_id
        -- 弃权票统计
        LEFT JOIN (
            SELECT 
                mv.topic_id,
                COUNT(DISTINCT mv.user_id) as people_count,
                COALESCE(SUM(ep.area), 0) as area_sum
            FROM sys_meeting_vote mv
            INNER JOIN sys_estate_user_property eup ON mv.user_id = eup.user_id
            INNER JOIN sys_estate_property ep ON eup.property_id = ep.property_id
            WHERE mv.meeting_id = #{meetingId}
                AND mv.vote_option = 2
                AND eup.community_id = #{communityId}
                AND eup.status = '1'
                AND (eup.del_flag = '0' OR eup.del_flag IS NULL)
                AND (ep.del_flag = '0' OR ep.del_flag IS NULL)
            GROUP BY mv.topic_id
        ) abstain_stats ON t.topic_id = abstain_stats.topic_id
        -- 实际投票统计(所有投票选项)
        LEFT JOIN (
            SELECT 
                mv.topic_id,
                COUNT(DISTINCT mv.user_id) as people_count,
                COALESCE(SUM(ep.area), 0) as area_sum
            FROM sys_meeting_vote mv
            INNER JOIN sys_estate_user_property eup ON mv.user_id = eup.user_id
            INNER JOIN sys_estate_property ep ON eup.property_id = ep.property_id
            WHERE mv.meeting_id = #{meetingId}
                AND eup.community_id = #{communityId}
                AND eup.status = '1'
                AND (eup.del_flag = '0' OR eup.del_flag IS NULL)
                AND (ep.del_flag = '0' OR ep.del_flag IS NULL)
            GROUP BY mv.topic_id
        ) voted_stats ON t.topic_id = voted_stats.topic_id
        WHERE 
            t.meeting_id = #{meetingId}
        ORDER BY 
            t.order_num, t.topic_id
    </select>

</mapper>
