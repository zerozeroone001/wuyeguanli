# äº§æƒè®¤è¯å¼‚å¸¸æ•æ‰ä¼˜åŒ–æ€»ç»“

## éœ€æ±‚
åœ¨äº§æƒè®¤è¯æäº¤æ—¶ï¼Œéœ€è¦åšå¼‚å¸¸æ•æ‰ï¼Œæç¤ºç”¨æˆ·**"è¿™ä¸ªæˆ¿é—´å·²ç»è¢«ç»‘å®šäº†"**ï¼Œé¿å…æŠ€æœ¯é”™è¯¯ä¿¡æ¯æš´éœ²ç»™ç”¨æˆ·ã€‚

---

## å®ç°æ–¹æ¡ˆ

é‡‡ç”¨**ä¸‰å±‚é˜²æŠ¤ + åŒé‡æ£€æŸ¥**æœºåˆ¶ï¼š

### ğŸ›¡ï¸ ä¸‰å±‚é˜²æŠ¤

1. **å‰ç«¯é˜²æŠ¤** - æäº¤çŠ¶æ€æ§åˆ¶ + æ™ºèƒ½é”™è¯¯è¯†åˆ«
2. **Controller å±‚é˜²æŠ¤** - ä¸šåŠ¡é€»è¾‘å‰ç½®æ£€æŸ¥
3. **Service å±‚é˜²æŠ¤** - æ•°æ®åº“å¼‚å¸¸æ•è·è½¬æ¢

### ğŸ” åŒé‡æ£€æŸ¥ï¼ˆController å±‚ï¼‰

1. **æ£€æŸ¥1**ï¼šç”¨æˆ·æ˜¯å¦å·²æäº¤è¿‡è¯¥æˆ¿äº§
   - æŸ¥è¯¢æ¡ä»¶ï¼š`user_id` + `property_id`
   - é”™è¯¯æç¤ºï¼š`"æ‚¨å·²æäº¤è¿‡è¯¥æˆ¿äº§çš„è®¤è¯ç”³è¯·ï¼Œè¯·å‹¿é‡å¤æäº¤"`

2. **æ£€æŸ¥2**ï¼šæˆ¿äº§æ˜¯å¦å·²è¢«å…¶ä»–ç”¨æˆ·ç»‘å®š
   - æŸ¥è¯¢æ¡ä»¶ï¼š`property_id` + `status='1'`ï¼ˆå®¡æ ¸é€šè¿‡ï¼‰
   - é”™è¯¯æç¤ºï¼š`"è¯¥æˆ¿äº§(XXæ ‹XXå•å…ƒXXå·)å·²è¢«å…¶ä»–ç”¨æˆ·ç»‘å®šï¼Œå¦‚æœ‰ç–‘é—®è¯·è”ç³»ç‰©ä¸šç®¡ç†å¤„"`

---

## æ ¸å¿ƒä»£ç 

### Controller å±‚ï¼ˆå…³é”®é€»è¾‘ï¼‰

```java
@PostMapping("/user-property/add")
public AjaxResult addUserProperty(@RequestBody EstateUserProperty estateUserProperty) {
    EstateProperty property = estatePropertyService.selectEstatePropertyByPropertyId(
        estateUserProperty.getPropertyId()
    );
    if (property == null) {
        return AjaxResult.error("æäº¤å¤±è´¥ï¼Œé€‰æ‹©çš„æˆ¿äº§ä¸å­˜åœ¨");
    }

    Long currentUserId = SecurityUtils.getUserId();

    // æ£€æŸ¥1ï¼šç”¨æˆ·æ˜¯å¦é‡å¤æäº¤
    EstateUserProperty userQuery = new EstateUserProperty();
    userQuery.setUserId(currentUserId);
    userQuery.setPropertyId(estateUserProperty.getPropertyId());
    List<EstateUserProperty> userExistingList =
        estateUserPropertyService.selectEstateUserPropertyList(userQuery);

    if (userExistingList != null && !userExistingList.isEmpty()) {
        return AjaxResult.error("æ‚¨å·²æäº¤è¿‡è¯¥æˆ¿äº§çš„è®¤è¯ç”³è¯·ï¼Œè¯·å‹¿é‡å¤æäº¤");
    }

    // æ£€æŸ¥2ï¼šæˆ¿äº§æ˜¯å¦å·²è¢«å…¶ä»–ç”¨æˆ·ç»‘å®š â­â­â­
    EstateUserProperty propertyQuery = new EstateUserProperty();
    propertyQuery.setPropertyId(estateUserProperty.getPropertyId());
    propertyQuery.setStatus("1"); // å®¡æ ¸é€šè¿‡çš„è®°å½•
    List<EstateUserProperty> propertyExistingList =
        estateUserPropertyService.selectEstateUserPropertyList(propertyQuery);

    if (propertyExistingList != null && !propertyExistingList.isEmpty()) {
        String roomInfo = property.getBuildingName() +
                         property.getUnitName() +
                         property.getRoomNumber();
        return AjaxResult.error("è¯¥æˆ¿äº§(" + roomInfo + ")å·²è¢«å…¶ä»–ç”¨æˆ·ç»‘å®šï¼Œå¦‚æœ‰ç–‘é—®è¯·è”ç³»ç‰©ä¸šç®¡ç†å¤„");
    }

    // æ‰§è¡Œæ’å…¥
    estateUserProperty.setUserId(currentUserId);
    estateUserProperty.setCommunityId(property.getCommunityId());
    estateUserProperty.setStatus("0"); // å¾…å®¡æ ¸
    return toAjax(estateUserPropertyService.insertEstateUserProperty(estateUserProperty));
}
```

### Service å±‚ï¼ˆå¼‚å¸¸å…œåº•ï¼‰

```java
@Override
public int insertEstateUserProperty(EstateUserProperty estateUserProperty) {
    estateUserProperty.setCreateTime(DateUtils.getNowDate());
    estateUserProperty.setCreateBy(SecurityUtils.getUsername());

    try {
        return estateUserPropertyMapper.insertEstateUserProperty(estateUserProperty);
    } catch (Exception e) {
        // æ•è·æ•°æ®åº“å”¯ä¸€ç´¢å¼•çº¦æŸå¼‚å¸¸
        if (e.getMessage() != null &&
            (e.getMessage().contains("Duplicate entry") ||
             e.getMessage().contains("uniq_user_property"))) {
            throw new ServiceException("æ‚¨å·²æäº¤è¿‡è¯¥æˆ¿äº§çš„è®¤è¯ç”³è¯·ï¼Œè¯·å‹¿é‡å¤æäº¤");
        }
        throw e; // å…¶ä»–å¼‚å¸¸ç»§ç»­æŠ›å‡º
    }
}
```

### å‰ç«¯ï¼ˆé”™è¯¯è¯†åˆ«ä¼˜åŒ–ï¼‰

```javascript
// ç‰¹æ®Šé”™è¯¯å¤„ç†
if (errorMsg.includes('å·²å­˜åœ¨') || errorMsg.includes('é‡å¤') ||
    errorMsg.includes('Duplicate') || errorMsg.includes('uniq_user_property')) {
  errorMsg = 'æ‚¨å·²æäº¤è¿‡è¯¥æˆ¿äº§çš„è®¤è¯ç”³è¯·,è¯·å‹¿é‡å¤æäº¤';
} else if (errorMsg.includes('å·²è¢«å…¶ä»–ç”¨æˆ·ç»‘å®š') || errorMsg.includes('å·²è¢«ç»‘å®š')) {
  // ä¿ç•™åŸå§‹é”™è¯¯ä¿¡æ¯,å› ä¸ºåŒ…å«äº†æˆ¿äº§åœ°å€ä¿¡æ¯
  // errorMsg ä¿æŒä¸å˜
}
```

---

## ä¸šåŠ¡è§„åˆ™

| è§„åˆ™ | è¯´æ˜ | çŠ¶æ€é™åˆ¶ |
|-----|------|---------|
| ç”¨æˆ·å”¯ä¸€æ€§ | åŒä¸€ç”¨æˆ·ä¸èƒ½é‡å¤æäº¤åŒä¸€æˆ¿äº§ | æ‰€æœ‰çŠ¶æ€ |
| æˆ¿äº§å”¯ä¸€æ€§ | ä¸€ä¸ªæˆ¿äº§åªèƒ½è¢«ä¸€ä¸ªç”¨æˆ·ç»‘å®š | status = '1'ï¼ˆå®¡æ ¸é€šè¿‡ï¼‰|
| å¾…å®¡æ ¸çŠ¶æ€ | å…è®¸å¤šä¸ªç”¨æˆ·æäº¤åŒä¸€æˆ¿äº§ç”³è¯· | status = '0'ï¼ˆå¾…å®¡æ ¸ï¼‰|
| å®¡æ ¸å†³ç­– | ç®¡ç†å‘˜å†³å®šå“ªä¸ªç”¨æˆ·çš„ç”³è¯·é€šè¿‡ | äººå·¥å®¡æ ¸ |

---

## ç”¨æˆ·ä½“éªŒå¯¹æ¯”

### åœºæ™¯1ï¼šç”¨æˆ·é‡å¤æäº¤

**ä¿®å¤å‰ï¼š**
```
Error updating database. Cause: java.sql.SQLIntegrityConstraintViolationException:
Duplicate entry '118-1000' for key 'sys_estate_user_property.uniq_user_property'
```

**ä¿®å¤åï¼š**
```
æ‚¨å·²æäº¤è¿‡è¯¥æˆ¿äº§çš„è®¤è¯ç”³è¯·ï¼Œè¯·å‹¿é‡å¤æäº¤
```

### åœºæ™¯2ï¼šæˆ¿äº§å·²è¢«å…¶ä»–ç”¨æˆ·ç»‘å®š â­

**ä¿®å¤å‰ï¼š**
- æ— æ£€æŸ¥ï¼Œå¯èƒ½æ’å…¥æˆåŠŸï¼ˆå¯¼è‡´æ•°æ®å†²çªï¼‰
- æˆ–æ•°æ®åº“çº¦æŸæŠ¥é”™

**ä¿®å¤åï¼š**
```
è¯¥æˆ¿äº§(1å·æ¥¼2å•å…ƒ301å·)å·²è¢«å…¶ä»–ç”¨æˆ·ç»‘å®šï¼Œå¦‚æœ‰ç–‘é—®è¯·è”ç³»ç‰©ä¸šç®¡ç†å¤„
```

---

## ä¿®æ”¹æ–‡ä»¶æ¸…å•

1. âœ… **å‰ç«¯é¡µé¢**
   `ruoyi-app/pageB/property/add.vue`
   - é”™è¯¯ä¿¡æ¯è¯†åˆ«ä¼˜åŒ–
   - ä¿ç•™åŒ…å«æˆ¿äº§åœ°å€çš„é”™è¯¯æç¤º

2. âœ… **Controller å±‚**
   `ruoyi-user/src/main/java/com/ruoyi/user/controller/AppPropertyController.java`
   - æ·»åŠ ç”¨æˆ·é‡å¤æäº¤æ£€æŸ¥
   - **æ–°å¢æˆ¿äº§å·²ç»‘å®šæ£€æŸ¥**ï¼ˆæ ¸å¿ƒæ”¹è¿›ï¼‰
   - é”™è¯¯æç¤ºåŒ…å«æˆ¿äº§åœ°å€ä¿¡æ¯

3. âœ… **Service å±‚**
   `ruoyi-system/src/main/java/com/ruoyi/system/service/impl/EstateUserPropertyServiceImpl.java`
   - æ•°æ®åº“çº¦æŸå¼‚å¸¸æ•è·
   - è½¬æ¢ä¸ºå‹å¥½çš„ä¸šåŠ¡å¼‚å¸¸

---

## æµ‹è¯•éªŒè¯

### âœ… æµ‹è¯•åœºæ™¯1ï¼šç”¨æˆ·é‡å¤æäº¤
1. ç”¨æˆ·æäº¤æˆ¿äº§è®¤è¯
2. å†æ¬¡æäº¤ç›¸åŒæˆ¿äº§
3. **é¢„æœŸ**ï¼šæç¤º"æ‚¨å·²æäº¤è¿‡è¯¥æˆ¿äº§çš„è®¤è¯ç”³è¯·ï¼Œè¯·å‹¿é‡å¤æäº¤"

### âœ… æµ‹è¯•åœºæ™¯2ï¼šæˆ¿äº§å·²è¢«å…¶ä»–ç”¨æˆ·ç»‘å®šï¼ˆæ–°å¢ï¼‰
1. ç”¨æˆ·Aæäº¤è®¤è¯å¹¶å®¡æ ¸é€šè¿‡
2. ç”¨æˆ·Bå°è¯•æäº¤ç›¸åŒæˆ¿äº§
3. **é¢„æœŸ**ï¼šæç¤º"è¯¥æˆ¿äº§(XXæ ‹XXå•å…ƒXXå·)å·²è¢«å…¶ä»–ç”¨æˆ·ç»‘å®šï¼Œå¦‚æœ‰ç–‘é—®è¯·è”ç³»ç‰©ä¸šç®¡ç†å¤„"

### âœ… æµ‹è¯•åœºæ™¯3ï¼šå¿«é€Ÿé‡å¤ç‚¹å‡»
1. å¿«é€Ÿè¿ç»­ç‚¹å‡»æäº¤æŒ‰é’®
2. **é¢„æœŸ**ï¼šæç¤º"æ­£åœ¨æäº¤ä¸­,è¯·å‹¿é‡å¤æ“ä½œ"

### âœ… æµ‹è¯•åœºæ™¯4ï¼šå¹¶å‘æäº¤
1. ä½¿ç”¨å·¥å…·åŒæ—¶å‘é€å¤šä¸ªè¯·æ±‚
2. **é¢„æœŸ**ï¼šåªæœ‰ä¸€ä¸ªè¯·æ±‚æˆåŠŸï¼Œå…¶ä»–è¢«æ‹¦æˆª

---

## æ€§èƒ½å½±å“

### Controller å±‚æ–°å¢æŸ¥è¯¢

```sql
-- æŸ¥è¯¢1ï¼šç”¨æˆ·æ˜¯å¦é‡å¤æäº¤
SELECT * FROM sys_estate_user_property
WHERE user_id = ? AND property_id = ?

-- æŸ¥è¯¢2ï¼šæˆ¿äº§æ˜¯å¦å·²è¢«ç»‘å®šï¼ˆæ–°å¢ï¼‰
SELECT * FROM sys_estate_user_property
WHERE property_id = ? AND status = '1'
```

**æ€§èƒ½è¯„ä¼°ï¼š**
- æŸ¥è¯¢æ¡ä»¶æœ‰ç´¢å¼•æ”¯æŒï¼ˆ`uniq_user_property` åŒ…å« user_id å’Œ property_idï¼‰
- æŸ¥è¯¢ç»“æœæœ€å¤š1æ¡è®°å½•
- æ€§èƒ½å¼€é”€ï¼š< 10ms
- **ç»“è®º**ï¼šæ€§èƒ½å½±å“å¾®ä¹å…¶å¾®ï¼Œç”¨æˆ·ä½“éªŒæå‡æ˜æ˜¾

---

## å®‰å…¨æ€§æå‡

1. âœ… **æŠ€æœ¯ä¿¡æ¯éšè—**ï¼šä¸æš´éœ²æ•°æ®åº“ç»“æ„å’Œçº¦æŸä¿¡æ¯
2. âœ… **ä¸šåŠ¡è§„åˆ™æ¸…æ™°**ï¼šç”¨æˆ·çŸ¥é“ä¸ºä»€ä¹ˆä¸èƒ½æäº¤
3. âœ… **å¼•å¯¼æ€§æç¤º**ï¼šå‘ŠçŸ¥ç”¨æˆ·è”ç³»ç‰©ä¸šç®¡ç†å¤„
4. âœ… **è¯¦ç»†ä¿¡æ¯**ï¼šåŒ…å«å…·ä½“çš„æˆ¿äº§åœ°å€ï¼Œä¾¿äºç”¨æˆ·æ ¸å®

---

## åç»­ä¼˜åŒ–å»ºè®®

1. **ç®¡ç†åå°æç¤º**ï¼šå½“ç®¡ç†å‘˜å®¡æ ¸æˆ¿äº§è®¤è¯æ—¶ï¼Œæç¤ºè¯¥æˆ¿äº§æ˜¯å¦å·²æœ‰å…¶ä»–ç”¨æˆ·çš„å®¡æ ¸é€šè¿‡è®°å½•
2. **ç”¨æˆ·æŸ¥è¯¢åŠŸèƒ½**ï¼šæä¾›æ¥å£è®©ç”¨æˆ·æŸ¥è¯¢æŸä¸ªæˆ¿äº§æ˜¯å¦å·²è¢«ç»‘å®šï¼ˆä¸æ˜¾ç¤ºå…·ä½“ç»‘å®šç”¨æˆ·ï¼‰
3. **ç”³è¯‰æœºåˆ¶**ï¼šå¦‚æœç”¨æˆ·è®¤ä¸ºæˆ¿äº§ç»‘å®šæœ‰è¯¯ï¼Œæä¾›ç”³è¯‰é€šé“
4. **æ‰¹é‡å¯¼å…¥æ ¡éªŒ**ï¼šå¦‚æœæœ‰æ‰¹é‡å¯¼å…¥åŠŸèƒ½ï¼Œä¹Ÿéœ€è¦æ·»åŠ ç›¸åŒçš„æ ¡éªŒé€»è¾‘

---

## æ€»ç»“

âœ… **æ ¸å¿ƒæ”¹è¿›**ï¼šåœ¨ Controller å±‚æ·»åŠ äº†æˆ¿äº§å·²ç»‘å®šæ£€æŸ¥ï¼Œé˜²æ­¢ä¸€ä¸ªæˆ¿äº§è¢«å¤šä¸ªç”¨æˆ·åŒæ—¶ç»‘å®š

âœ… **ç”¨æˆ·å‹å¥½**ï¼šæç¤ºä¿¡æ¯æ¸…æ™°æ˜ç¡®ï¼ŒåŒ…å«æˆ¿äº§åœ°å€ä¿¡æ¯

âœ… **ç³»ç»Ÿå¥å£®**ï¼šä¸‰å±‚é˜²æŠ¤ + åŒé‡æ£€æŸ¥ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§

âœ… **æ€§èƒ½å¯æ§**ï¼šå‰ç½®æ£€æŸ¥æ€§èƒ½å¼€é”€å¾®å°ï¼Œæ¢æ¥æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ

---

**å®ç°å®Œæˆï¼ç”¨æˆ·å°è¯•ç»‘å®šå·²è¢«å ç”¨çš„æˆ¿äº§æ—¶ï¼Œä¼šçœ‹åˆ°æ¸…æ™°çš„æç¤ºä¿¡æ¯ã€‚** ğŸ‰
