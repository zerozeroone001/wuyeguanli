# 首页手机号检测功能说明

## 需求描述
在首页的所有按钮点击时，都需要先检测用户是否已绑定手机号。如果未绑定，则弹出手机号绑定弹窗。

---

## 实现方案

### 1. 核心方法

#### `isPhoneBound()` - 仅检查
仅检查用户是否绑定了手机号，不执行任何UI操作。

```javascript
isPhoneBound() {
  // 从store中获取用户手机号
  const phonenumber = this.$store.state.user.phonenumber
  return phonenumber && phonenumber.trim() !== ''
}
```

#### `checkPhoneBound()` - 检查并弹窗
检查用户是否绑定手机号，如果未绑定则弹出绑定弹窗。

```javascript
checkPhoneBound() {
  if (!this.isPhoneBound()) {
    // 未绑定手机号，弹出绑定弹窗
    this.$refs.phoneBindModal.open()
    return false
  }
  return true
}
```

#### `onPhoneBindSuccess()` - 绑定成功回调
当用户成功绑定手机号后，刷新用户信息。

```javascript
onPhoneBindSuccess() {
  // 绑定成功后刷新用户信息
  this.$store.dispatch('GetInfo').then(() => {
    uni.showToast({
      title: '手机号绑定成功',
      icon: 'success'
    })
  }).catch(error => {
    console.error('刷新用户信息失败:', error)
  })
}
```

---

### 2. 已添加检测的按钮

#### 2.1 快捷入口按钮

##### 业主变更
```javascript
goToOwnerChange() {
  // 检查是否绑定手机号
  if (!this.checkPhoneBound()) {
    return
  }

  uni.navigateTo({
    url: '/pageB/owner-change/submit',
    // ...
  });
}
```

##### 产权认证
```javascript
goToPropertyAuth() {
  // 检查是否绑定手机号
  if (!this.checkPhoneBound()) {
    return
  }

  uni.navigateTo({
    url: '/pageB/property/index',
    // ...
  });
}
```

#### 2.2 主要服务按钮（9宫格）

```javascript
handleServiceClick(service) {
  // 检查是否绑定手机号
  if (!this.checkPhoneBound()) {
    return
  }

  // 检查业委会会议权限
  if (service.name === '业委会会议' && this.ownerProfile.isOwner !== 2) {
    uni.showModal({
      title: '权限不足',
      content: '您不是业委会成员，无法访问业委会会议功能',
      showCancel: false,
      confirmText: '我知道了'
    })
    return
  }

  // 跳转到服务页面
  if (service.path) {
    uni.navigateTo({ url: service.path })
  }
}
```

涵盖的服务包括：
1. ✅ 业主大会
2. ✅ 业委会会议
3. ✅ 意见征询
4. ✅ 合同查阅
5. ✅ 资金公示
6. ✅ 法律咨询
7. ✅ 制度查阅
8. ✅ 联名签名
9. ✅ 指导监督
10. ✅ 承接查验

#### 2.3 认证引导按钮

```javascript
goAuth() {
  // 如果未认证，先检查是否绑定手机号
  if (!this.authStatus) {
    // 检查是否绑定手机号
    if (!this.checkPhoneBound()) {
      return
    }

    // 已绑定手机号，跳转到业主认证页面
    uni.navigateTo({
      url: '/pageB/property/add'
    })
  }
}
```

---

## 用户体验流程

### 流程1：未绑定手机号

```
用户点击任意功能按钮
    ↓
检测到未绑定手机号
    ↓
弹出手机号绑定弹窗
    ↓
用户输入手机号和验证码
    ↓
绑定成功
    ↓
刷新用户信息
    ↓
显示"手机号绑定成功"提示
    ↓
用户可以正常使用功能
```

### 流程2：已绑定手机号

```
用户点击功能按钮
    ↓
检测到已绑定手机号
    ↓
直接跳转到目标页面
```

---

## 技术细节

### 手机号绑定弹窗组件

组件位置：`@/components/phone-bind-modal/phone-bind-modal.vue`

引入方式：
```vue
<template>
  <view>
    <!-- 手机号绑定弹窗 -->
    <phone-bind-modal ref="phoneBindModal" @success="onPhoneBindSuccess" />

    <!-- 页面其他内容 -->
  </view>
</template>

<script>
import PhoneBindModal from '@/components/phone-bind-modal/phone-bind-modal.vue'

export default {
  components: {
    PhoneBindModal
  }
}
</script>
```

### Store 状态管理

手机号存储在 Vuex Store 中：

```javascript
// 获取手机号
this.$store.state.user.phonenumber

// 刷新用户信息（包含手机号）
this.$store.dispatch('GetInfo')
```

---

## 修改文件

### 主要修改文件

✅ `ruoyi-app/pages/index.vue` - 首页添加手机号检测

---

## 测试建议

### 测试场景1：未绑定手机号
1. 使用未绑定手机号的账号登录
2. 点击首页任意功能按钮
3. **预期**：弹出手机号绑定弹窗
4. 输入手机号和验证码完成绑定
5. **预期**：显示"手机号绑定成功"
6. 再次点击功能按钮
7. **预期**：直接跳转到目标页面

### 测试场景2：已绑定手机号
1. 使用已绑定手机号的账号登录
2. 点击首页任意功能按钮
3. **预期**：直接跳转到目标页面，不弹出绑定弹窗

### 测试场景3：绑定弹窗关闭
1. 使用未绑定手机号的账号登录
2. 点击功能按钮
3. 弹出绑定弹窗后，点击关闭或取消
4. **预期**：弹窗关闭，停留在当前页面
5. 再次点击功能按钮
6. **预期**：再次弹出绑定弹窗

### 测试场景4：绑定失败
1. 使用未绑定手机号的账号登录
2. 点击功能按钮
3. 在绑定弹窗中输入错误的验证码
4. **预期**：显示绑定失败提示
5. 弹窗不关闭，允许用户重新尝试

---

## 需要检测的按钮清单

### 快捷入口区域
- ✅ 业主变更按钮
- ✅ 产权认证按钮

### 主要服务区域（9宫格）
- ✅ 业主大会
- ✅ 业委会会议
- ✅ 意见征询
- ✅ 合同查阅
- ✅ 资金公示
- ✅ 法律咨询
- ✅ 制度查阅
- ✅ 联名签名
- ✅ 指导监督
- ✅ 承接查验

### 认证引导
- ✅ "去绑定"按钮（跳转到产权认证）

### 其他按钮
- ❌ 消息按钮（无需检测，查看消息不需要手机号）
- ❌ 小区切换（无需检测，切换小区不需要手机号）
- ❌ 公告查看（无需检测，查看公告不需要手机号）
- ❌ 轮播图点击（根据链接类型决定，暂不统一添加）

---

## 注意事项

1. **登录检测**：所有功能按钮已经在路由守卫层面有登录检测，此处只添加手机号检测

2. **检测顺序**：
   - 第1步：路由守卫检查登录状态
   - 第2步：按钮点击时检查手机号绑定
   - 第3步：检查业务权限（如业委会会议权限）
   - 第4步：跳转到目标页面

3. **用户体验**：
   - 弹窗出现时，背景应有遮罩
   - 绑定成功后，自动刷新用户信息
   - 避免重复弹窗

4. **异常处理**：
   - 绑定失败时，给予明确提示
   - 网络错误时，允许用户重试
   - 验证码错误时，允许重新获取

---

## 扩展说明

### 其他页面适用性

此手机号检测模式可以推广到其他页面，只需：

1. 引入 `PhoneBindModal` 组件
2. 添加 `checkPhoneBound()` 方法
3. 在需要的按钮点击方法中调用检测

示例代码：
```javascript
methods: {
  // 复用检测方法
  checkPhoneBound() {
    const phonenumber = this.$store.state.user.phonenumber
    if (!phonenumber || phonenumber.trim() === '') {
      this.$refs.phoneBindModal.open()
      return false
    }
    return true
  },

  // 在按钮点击中使用
  handleButtonClick() {
    if (!this.checkPhoneBound()) {
      return
    }
    // 执行业务逻辑
  }
}
```

---

## 总结

✅ **实现完成**：首页所有主要功能按钮都已添加手机号检测

✅ **用户友好**：未绑定时弹出绑定弹窗，而非直接拒绝访问

✅ **扩展性好**：检测方法可复用到其他页面

✅ **体验流畅**：绑定成功后自动刷新，用户无需重新操作

---

**功能已完成，可以进行测试！** 🎉
