# 手机号绑定后端接口实现说明

## 实现概述
完成了手机号绑定功能的两个核心接口:`/system/user/sendCode`(发送验证码)和`/system/user/bindPhone`(绑定手机号),使用Redis缓存验证码并实现发送频率限制。

## 文件清单

### 1. 工具类
- **文件**: `ruoyi-common/src/main/java/com/ruoyi/common/utils/SmsUtils.java`
- **功能**:
  - `generateCode()` - 生成6位随机验证码
  - `generateCode(int length)` - 生成指定长度验证码
  - `sendSms(String phone, String code)` - 发送短信(当前为模拟发送)
  - `isValidPhone(String phone)` - 验证手机号格式
  - `hidePhone(String phone)` - 隐藏手机号中间4位

### 2. Controller接口
- **文件**: `ruoyi-admin/src/main/java/com/ruoyi/web/controller/system/SysUserController.java`
- **新增接口**:
  1. `POST /system/user/sendCode` - 发送验证码
  2. `POST /system/user/bindPhone` - 绑定手机号

## 接口详细说明

### 1. 发送验证码接口

#### 请求信息
```
POST /system/user/sendCode
Content-Type: application/json

{
  "phone": "13800138000"
}
```

#### 业务流程
1. 验证手机号格式(1开头,11位数字)
2. 检查发送频率(60秒内不能重复发送)
3. 生成6位随机验证码
4. 将验证码保存到Redis(有效期10分钟)
5. 记录发送时间到Redis(60秒)
6. 调用短信平台发送验证码(当前为模拟发送)

#### Redis Key设计
- **验证码Key**: `sms:code:{phone}` - 存储验证码,有效期10分钟
- **发送频率Key**: `sms:send:{phone}` - 控制发送频率,有效期60秒

#### 返回示例
```json
{
  "code": 200,
  "msg": "验证码发送成功"
}
```

#### 错误情况
- 手机号格式不正确 → `{"code": 500, "msg": "手机号格式不正确"}`
- 发送过于频繁 → `{"code": 500, "msg": "验证码发送过于频繁,请稍后再试"}`
- 发送失败 → `{"code": 500, "msg": "验证码发送失败,请稍后重试"}`

### 2. 绑定手机号接口

#### 请求信息
```
POST /system/user/bindPhone
Content-Type: application/json
Authorization: Bearer {token}

{
  "phone": "13800138000",
  "code": "123456"
}
```

#### 业务流程
1. 验证手机号格式
2. 验证验证码格式(6位数字)
3. 从Redis获取保存的验证码
4. 校验验证码是否正确
5. 检查手机号是否已被其他用户绑定
6. 更新当前用户的手机号
7. 删除Redis中的验证码
8. 返回更新后的用户信息

#### 返回示例
```json
{
  "code": 200,
  "msg": "绑定成功",
  "data": {
    "userId": 1,
    "phonenumber": "13800138000"
  }
}
```

#### 错误情况
- 手机号格式不正确 → `{"code": 500, "msg": "手机号格式不正确"}`
- 验证码格式不正确 → `{"code": 500, "msg": "验证码格式不正确"}`
- 验证码已过期 → `{"code": 500, "msg": "验证码已过期,请重新获取"}`
- 验证码错误 → `{"code": 500, "msg": "验证码错误"}`
- 手机号已被绑定 → `{"code": 500, "msg": "该手机号已被其他用户绑定"}`
- 绑定失败 → `{"code": 500, "msg": "绑定失败,请稍后重试"}`

## 安全特性

### 1. 验证码安全
- ✅ 验证码长度: 6位数字
- ✅ 验证码有效期: 10分钟
- ✅ 一次性使用: 验证成功后立即删除
- ✅ 不可重复使用: 使用后从Redis删除

### 2. 发送频率控制
- ✅ 60秒内只能发送一次
- ✅ 使用Redis过期时间自动清理
- ✅ 防止恶意刷验证码

### 3. 手机号唯一性
- ✅ 检查手机号是否已被其他用户绑定
- ✅ 允许用户重新绑定自己的手机号
- ✅ 防止手机号冲突

### 4. 用户认证
- ✅ 需要用户登录(携带token)
- ✅ 只能绑定当前登录用户
- ✅ 使用Spring Security保护

## 数据库操作

### 更新用户表
```sql
UPDATE sys_user
SET phonenumber = ?,
    update_by = ?,
    update_time = NOW()
WHERE user_id = ?
```

### 查询手机号是否存在
```sql
SELECT * FROM sys_user
WHERE phonenumber = ?
```

## Redis配置要求

### 依赖项
项目已集成Spring Data Redis,无需额外添加依赖。

### Redis配置
在`application.yml`中配置Redis连接信息:
```yaml
spring:
  redis:
    host: localhost
    port: 6379
    database: 0
    password:
    timeout: 10000
    lettuce:
      pool:
        max-active: 8
        max-wait: -1
        max-idle: 8
        min-idle: 0
```

## 测试说明

### 1. 发送验证码测试
```bash
curl -X POST http://localhost:8080/system/user/sendCode \
  -H "Content-Type: application/json" \
  -d '{"phone":"13800138000"}'
```

### 2. 绑定手机号测试
```bash
curl -X POST http://localhost:8080/system/user/bindPhone \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {your_token}" \
  -d '{
    "phone":"13800138000",
    "code":"123456"
  }'
```

### 3. 查看Redis中的验证码
```bash
# 连接Redis
redis-cli

# 查看验证码
GET sms:code:13800138000

# 查看发送时间
GET sms:send:13800138000

# 查看所有短信相关key
KEYS sms:*
```

## 短信平台对接

### 当前状态
- 目前使用`SmsUtils.sendSms()`模拟发送
- 验证码会打印到控制台
- **生产环境需要对接真实短信平台**

### 对接步骤

#### 1. 选择短信平台
推荐平台:
- 阿里云短信服务
- 腾讯云短信服务
- 华为云短信服务

#### 2. 添加依赖(以阿里云为例)
```xml
<dependency>
    <groupId>com.aliyun</groupId>
    <artifactId>dysmsapi20170525</artifactId>
    <version>2.0.24</version>
</dependency>
```

#### 3. 配置短信参数
在`application.yml`中添加:
```yaml
aliyun:
  sms:
    access-key-id: your_access_key_id
    access-key-secret: your_access_key_secret
    sign-name: 你的签名
    template-code: SMS_123456789
```

#### 4. 实现真实发送逻辑
修改`SmsUtils.sendSms()`方法,调用短信平台API。

## 扩展功能

### 可选扩展
1. **图形验证码前置**: 发送验证码前先验证图形验证码
2. **IP限流**: 限制同一IP的发送次数
3. **手机号黑名单**: 防止恶意手机号
4. **发送日志**: 记录所有验证码发送记录
5. **短信模板**: 支持多种短信模板
6. **国际短信**: 支持国际手机号

## 注意事项

### 开发环境
- ✅ 控制台会打印验证码,方便测试
- ✅ 不会真实发送短信,节省成本

### 生产环境
- ⚠️ 必须对接真实短信平台
- ⚠️ 配置短信签名和模板
- ⚠️ 设置每日发送上限
- ⚠️ 监控短信发送状态
- ⚠️ 做好异常处理和日志记录

## 常见问题

### Q1: 验证码收不到?
A: 检查以下几点:
1. Redis服务是否正常运行
2. 控制台是否打印了验证码
3. 是否在60秒内重复发送
4. 手机号格式是否正确

### Q2: 验证码总是提示过期?
A: 检查:
1. Redis是否正常运行
2. 验证码是否在10分钟内使用
3. Redis配置是否正确

### Q3: 提示手机号已被绑定?
A: 说明该手机号已被其他用户使用,需要换一个手机号。

### Q4: 生产环境如何切换到真实短信?
A:
1. 选择短信平台并注册账号
2. 添加短信平台SDK依赖
3. 配置access key和签名模板
4. 修改`SmsUtils.sendSms()`实现真实发送

## 版本历史

### v1.0.0 (2024-01-20)
- ✅ 发送验证码接口
- ✅ 绑定手机号接口
- ✅ Redis缓存验证码
- ✅ 60秒发送频率限制
- ✅ 10分钟验证码有效期
- ✅ 手机号唯一性检查
- ✅ 模拟短信发送
