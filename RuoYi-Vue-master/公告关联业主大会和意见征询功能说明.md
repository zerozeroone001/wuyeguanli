# 公告关联业主大会和意见征询功能说明

## 功能概述

实现了公告与业主大会、意见征询的关联功能，管理端可以在编辑公告时选择绑定业主大会或意见征询，用户端公告详情页面会显示跳转按钮，点击可直接跳转到对应的详情页面。

## 功能实现

### 1. 数据库修改

**文件位置：** `sql/2025-01-16-add-notice-relation.sql`

为 `sys_notice` 表添加了两个新字段：
- `relation_type`：关联类型（meeting-业主大会，opinion-意见征询）
- `relation_id`：关联的业务ID

并添加了索引以提高查询性能。

**执行步骤：**
```bash
# 需要执行SQL脚本
mysql -u用户名 -p数据库名 < sql/2025-01-16-add-notice-relation.sql
```

### 2. 后端修改

#### 2.1 实体类修改

**文件位置：** `ruoyi-system/src/main/java/com/ruoyi/system/domain/SysNotice.java`

新增字段：
```java
/** 关联类型（meeting-业主大会，opinion-意见征询） */
private String relationType;

/** 关联的业务ID */
private Long relationId;
```

#### 2.2 Mapper XML修改

**文件位置：** `ruoyi-system/src/main/resources/mapper/system/SysNoticeMapper.xml`

修改内容：
- resultMap 新增 relation_type 和 relation_id 映射
- selectNoticeVo SQL新增这两个字段
- insertNotice 和 updateNotice 支持这两个字段的插入和更新

### 3. 管理端修改

**文件位置：** `ruoyi-ui/src/views/system/notice/index.vue`

#### 3.1 新增功能

1. **关联类型选择**
   - 下拉框选择：业主大会 或 意见征询
   - 选择后清空之前的关联ID

2. **关联内容选择**
   - 根据关联类型动态加载对应列表
   - 支持搜索过滤
   - 显示业务标题供选择

3. **数据保存**
   - 保存时将关联类型和关联ID一并提交
   - 编辑时自动加载已关联的数据

#### 3.2 主要方法

- `handleRelationTypeChange(value)` - 关联类型改变时触发
- `loadRelationOptions(type)` - 加载关联数据选项列表

### 4. 用户端修改

**文件位置：** `ruoyi-app/pages/common/notice/detail.vue`

#### 4.1 新增功能

1. **关联按钮显示**
   - 仅当公告有关联类型和关联ID时显示
   - 按钮文案根据关联类型动态显示：
     - 业主大会：显示"查看业主大会详情"
     - 意见征询：显示"查看意见征询详情"

2. **跳转功能**
   - 点击按钮跳转到对应详情页面
   - 业主大会：跳转到 `/pageB/property/meeting/detail?id=XXX`
   - 意见征询：跳转到 `/pages/work/opinion/detail?id=XXX`
   - 跳转失败时显示提示信息

3. **按钮样式**
   - 渐变紫色背景
   - 包含图标、文字和箭头
   - 点击有缩放反馈效果
   - 带阴影效果增强视觉层次

## 使用说明

### 管理端操作

1. 进入"系统管理" -> "公告管理"
2. 点击"新增"或"修改"按钮打开公告编辑对话框
3. 填写公告标题、类型、内容等基本信息
4. （可选）选择"关联类型"：
   - 选择"业主大会"，则下方显示业主大会选择框
   - 选择"意见征询"，则下方显示意见征询选择框
5. 在关联内容选择框中选择具体的业主大会或意见征询
6. 点击"确定"保存

### 用户端效果

1. 用户打开公告详情页面
2. 如果公告有关联的业主大会或意见征询，会在内容下方显示一个紫色渐变按钮
3. 按钮文字显示"查看业主大会详情"或"查看意见征询详情"
4. 点击按钮直接跳转到对应的详情页面

## 关联页面路径

- 业主大会详情：`/pageB/property/meeting/detail`
- 意见征询详情：`/pages/work/opinion/detail`

## 注意事项

1. 必须先执行数据库SQL脚本，否则后端会报错
2. 关联类型为可选字段，不填写不影响公告的正常使用
3. 如果关联的业主大会或意见征询被删除，建议同步清除公告的关联关系
4. 管理端选择关联内容时，会加载最近100条数据，支持搜索过滤

## 技术细节

### 字段说明

| 字段名 | 类型 | 说明 | 可选值 |
|--------|------|------|--------|
| relation_type | VARCHAR(20) | 关联类型 | meeting: 业主大会<br>opinion: 意见征询 |
| relation_id | BIGINT(20) | 关联的业务ID | 对应业主大会的meetingId或意见征询的consultationId |

### API接口

管理端使用的API：
- `/system/meeting/list` - 获取业主大会列表
- `/system/opinionConsultation/list` - 获取意见征询列表
- `/system/notice` - 公告的增删改查接口

用户端使用的API：
- `/notice/{id}` - 获取公告详情（已包含关联字段）

## 文件清单

### 新增文件
- `sql/2025-01-16-add-notice-relation.sql` - 数据库脚本

### 修改文件
- `ruoyi-system/src/main/java/com/ruoyi/system/domain/SysNotice.java` - 实体类
- `ruoyi-system/src/main/resources/mapper/system/SysNoticeMapper.xml` - Mapper XML
- `ruoyi-ui/src/views/system/notice/index.vue` - 管理端公告页面
- `ruoyi-app/pages/common/notice/detail.vue` - 用户端公告详情页

## 后续优化建议

1. 可以考虑在公告列表页面显示关联状态图标
2. 可以添加关联数据的级联删除或解除关联的机制
3. 可以增加关联数据的有效性校验（确保关联的ID存在）
4. 可以在业主大会或意见征询详情页显示相关公告列表
