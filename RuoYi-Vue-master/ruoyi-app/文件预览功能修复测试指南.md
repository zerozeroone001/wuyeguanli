# 用户端会议详情文件预览功能修复测试指南

## 修复内容概述

本次修复主要解决了用户端会议详情页面文件预览功能的以下问题：

1. **文件URL构建问题**：修复了文件URL构建逻辑，确保正确拼接baseUrl和文件路径
2. **文件访问路径问题**：统一使用`/profile/`前缀访问静态资源
3. **文件下载方式问题**：改进了文件下载和预览的错误处理
4. **代码复用问题**：创建了通用的文件预览工具函数

## 修复的文件

### 1. 核心工具函数
- `ruoyi-app/utils/filePreview.js` - 新增通用文件预览工具函数

### 2. 会议相关页面
- `ruoyi-app/pages/property/meeting/detail.vue` - 会议详情页面
- `ruoyi-app/pages/property/meeting/vote.vue` - 会议投票页面  
- `ruoyi-app/pages/property/meeting/result.vue` - 会议结果页面

### 3. 其他功能页面
- `ruoyi-app/pages/notary-service/apply.vue` - 公证服务申请页面
- `ruoyi-app/pages/supervision/detail.vue` - 监督检查详情页面

## 测试步骤

### 1. 基础功能测试

#### 1.1 会议详情页面文件预览
1. 打开小程序，进入会议详情页面
2. 找到有附件的议题
3. 点击附件图标
4. 验证文件是否能正常下载和预览

#### 1.2 不同文件格式测试
测试以下文件格式的预览功能：
- **图片文件**：`.jpg`, `.png`, `.jpeg`, `.gif`
- **PDF文件**：`.pdf`
- **Office文档**：`.doc`, `.docx`, `.xls`, `.xlsx`, `.ppt`, `.pptx`
- **文本文件**：`.txt`
- **压缩文件**：`.zip`, `.rar`, `.7z`

### 2. 错误处理测试

#### 2.1 网络异常测试
1. 断开网络连接
2. 尝试预览文件
3. 验证是否显示"文件下载失败，请检查网络连接"提示

#### 2.2 文件不存在测试
1. 使用无效的文件URL
2. 尝试预览文件
3. 验证是否显示"无效的文件信息"提示

#### 2.3 不支持的文件格式测试
1. 尝试预览不支持的文件格式
2. 验证是否显示"不支持预览该文件格式"提示

### 3. 性能测试

#### 3.1 大文件下载测试
1. 上传较大的文件（如10MB的PDF）
2. 尝试预览文件
3. 验证下载速度和预览效果

#### 3.2 并发下载测试
1. 同时点击多个附件进行预览
2. 验证系统稳定性

### 4. 用户体验测试

#### 4.1 加载提示测试
1. 点击文件预览
2. 验证是否显示"文件加载中..."提示
3. 验证加载完成后提示是否消失

#### 4.2 操作反馈测试
1. 验证所有操作都有相应的Toast提示
2. 验证错误信息是否清晰易懂

## 预期结果

### 成功场景
1. **图片文件**：使用`uni.previewImage`进行预览
2. **PDF文件**：使用webview页面进行预览
3. **其他文件**：下载后使用`uni.openDocument`进行预览
4. **错误处理**：显示相应的错误提示信息

### 控制台日志
修复后的代码会在控制台输出以下调试信息：
- `文件预览URL: [完整的文件URL]`
- `文件扩展名: [文件扩展名]`
- `文件下载成功: [下载结果]`
- `文件预览失败: [错误信息]`（仅在失败时）

## 技术实现细节

### 1. 文件URL构建逻辑
```javascript
function buildFileUrl(fileUrl, baseUrl) {
  if (fileUrl.startsWith('http://') || fileUrl.startsWith('https://')) {
    return fileUrl; // 完整URL直接使用
  } else if (fileUrl.startsWith('/profile/')) {
    return baseUrl + fileUrl; // 已有profile前缀
  } else {
    return baseUrl + '/profile' + fileUrl; // 添加profile前缀
  }
}
```

### 2. 文件类型判断
```javascript
function getFileExtension(fileName) {
  return fileName.split('.').pop().toLowerCase();
}
```

### 3. 预览方式选择
- **图片文件**：`uni.previewImage`
- **PDF文件**：webview页面
- **其他文件**：`uni.downloadFile` + `uni.openDocument`

## 注意事项

1. **文件路径**：确保后端静态资源配置正确，路径为`/profile/**`
2. **网络环境**：测试时注意网络环境，确保能正常访问后端服务
3. **文件权限**：确保上传的文件有正确的访问权限
4. **小程序限制**：注意小程序对文件下载和预览的限制

## 回滚方案

如果修复后出现问题，可以通过以下方式回滚：

1. 恢复原始的文件预览函数
2. 移除`filePreview.js`工具函数的引用
3. 使用原来的简单URL拼接方式

## 后续优化建议

1. **缓存机制**：对已下载的文件进行本地缓存
2. **进度显示**：显示文件下载进度
3. **预览优化**：支持更多文件格式的在线预览
4. **错误重试**：添加下载失败后的重试机制