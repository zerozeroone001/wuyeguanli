# 微信订阅消息接入指南

## 概述
本指南将帮助您为若依物业管理系统的小程序端接入微信订阅消息通知功能。

## 1. 微信公众平台配置

### 1.1 登录微信公众平台
1. 访问 [微信公众平台](https://mp.weixin.qq.com)
2. 使用小程序管理员账号登录
3. 进入小程序管理后台

### 1.2 配置订阅消息模板
1. 在左侧菜单中找到"功能" -> "订阅消息"
2. 点击"公共模板库"选择合适的模板
3. 为以下业务场景配置模板：

#### 投诉处理通知模板
- **模板标题**: 投诉处理通知
- **模板内容**: 
  ```
  {{thing1.DATA}}
  处理状态：{{phrase2.DATA}}
  备注：{{thing3.DATA}}
  ```
- **使用场景**: 投诉处理进度更新

#### 会议通知模板
- **模板标题**: 会议通知
- **模板内容**:
  ```
  {{thing1.DATA}}
  会议时间：{{time2.DATA}}
  会议地点：{{thing3.DATA}}
  ```
- **使用场景**: 业主大会、业委会会议通知

#### 缴费提醒模板
- **模板标题**: 缴费提醒
- **模板内容**:
  ```
  费用类型：{{thing1.DATA}}
  金额：{{amount2.DATA}}
  到期时间：{{time3.DATA}}
  ```
- **使用场景**: 物业费、水电费缴费提醒

#### 维修进度通知模板
- **模板标题**: 维修进度通知
- **模板内容**:
  ```
  {{thing1.DATA}}
  维修状态：{{phrase2.DATA}}
  备注：{{thing3.DATA}}
  ```
- **使用场景**: 设备维修进度更新

### 1.3 获取模板ID
配置完成后，记录每个模板的ID，用于后续配置。

## 2. 前端配置

### 2.1 更新配置文件
在 `ruoyi-app/utils/subscribeConfig.js` 中更新模板ID：

```javascript
const SubscribeConfig = {
  templates: {
    // 替换为实际的模板ID
    complaint: 'your_complaint_template_id',
    meeting: 'your_meeting_template_id', 
    payment: 'your_payment_template_id',
    repair: 'your_repair_template_id'
  }
}
```

### 2.2 更新后端配置
在 `ruoyi-user/src/main/resources/application.yml` 中更新模板ID：

```yaml
wx:
  subscribe:
    complaint: "your_complaint_template_id"
    meeting: "your_meeting_template_id"
    payment: "your_payment_template_id"
    repair: "your_repair_template_id"
```

## 3. 功能使用

### 3.1 订阅消息授权
用户可以通过以下方式授权订阅消息：

1. **个人中心设置**
   - 进入"个人中心" -> "订阅消息"
   - 开启/关闭各类通知订阅

2. **业务场景授权**
   - 提交投诉时自动请求授权
   - 参与会议时请求授权
   - 其他业务场景中的授权

### 3.2 发送订阅消息
后端可以通过以下接口发送订阅消息：

```java
// 发送投诉处理通知
wechatService.sendComplaintNotification(openId, "噪音投诉", "处理中", "已安排工作人员现场查看");

// 发送会议通知  
wechatService.sendMeetingNotification(openId, "业主大会", "2024-01-15 19:00", "小区会议室");

// 发送缴费提醒
wechatService.sendPaymentReminder(openId, "物业费", "1200元", "2024-01-31");

// 发送维修进度通知
wechatService.sendRepairNotification(openId, "电梯维修", "已完成", "电梯已恢复正常运行");
```

## 4. 测试验证

### 4.1 功能测试
1. 使用微信开发者工具打开小程序
2. 进入"测试" -> "订阅消息演示"页面
3. 点击各个演示按钮测试订阅授权
4. 检查授权结果和用户提示

### 4.2 业务集成测试
1. 提交投诉，验证是否弹出订阅授权
2. 在个人中心管理订阅状态
3. 后端发送测试消息验证接收

## 5. 注意事项

### 5.1 订阅消息限制
- 用户每次授权只能发送一次消息
- 需要用户主动触发才能请求授权
- 授权结果需要妥善处理

### 5.2 模板内容规范
- 模板内容必须符合微信规范
- 参数值长度有限制
- 避免敏感词汇

### 5.3 用户体验
- 授权请求要适时，避免频繁打扰
- 提供清晰的授权说明
- 允许用户随时取消订阅

## 6. 常见问题

### Q: 订阅消息发送失败？
A: 检查模板ID是否正确，用户是否已授权，access_token是否有效。

### Q: 用户拒绝授权怎么办？
A: 正常处理，不要强制要求，可以在合适的时机再次请求。

### Q: 如何批量发送订阅消息？
A: 需要逐个发送，微信不支持批量发送订阅消息。

## 7. 扩展功能

### 7.1 更多业务场景
可以根据需要添加更多订阅消息模板：
- 访客登记通知
- 设备保修通知  
- 法律咨询回复通知
- 公证服务进度通知

### 7.2 消息统计
可以添加消息发送统计功能，监控订阅消息的使用情况。

---

通过以上步骤，您就可以成功为小程序接入微信订阅消息功能了。如有问题，请参考微信官方文档或联系技术支持。