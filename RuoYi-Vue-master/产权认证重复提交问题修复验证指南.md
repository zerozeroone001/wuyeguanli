# 产权认证重复提交问题修复验证指南

## 问题描述

### 问题1：重复提交相同房产

**原始错误信息：**
```
Error updating database. Cause: java.sql.SQLIntegrityConstraintViolationException:
Duplicate entry '118-1000' for key 'sys_estate_user_property.uniq_user_property'
```

**问题原因：**
- 数据库表 `sys_estate_user_property` 存在唯一索引约束 `uniq_user_property`
- 该约束保证同一用户(user_id)不能重复提交同一房产(property_id)的认证申请
- 当用户尝试重复提交时，数据库层面会抛出约束冲突异常
- 原代码未在应用层处理该异常，导致技术错误信息直接暴露给用户

### 问题2：房产已被其他用户绑定

**业务场景：**
- 一个房产只能被一个业主绑定（审核通过状态）
- 当用户尝试绑定已被其他人绑定的房产时，应给予明确提示
- 原代码缺少此类业务规则校验

---

## 修复方案

### 方案概述
采用**三层防护机制**，从前端到后端全面防止重复提交：

1. **前端防护** - 页面提交状态控制
2. **Controller 层防护** - 业务逻辑前置检查
3. **Service 层防护** - 数据库异常捕获和转换

---

## 修复内容详解

### 1. 前端优化（前端防护）

**文件位置：** [ruoyi-app/pageB/property/add.vue](ruoyi-app/pageB/property/add.vue)

#### 改进点：

**a. 提交状态控制**
```javascript
data() {
  return {
    submitting: false,  // 提交状态标记
    // ...
  }
}

async doSubmit() {
  // 防止重复提交
  if (this.submitting) {
    uni.showToast({
      title: '正在提交中,请勿重复操作',
      icon: 'none'
    });
    return;
  }

  this.submitting = true;
  // ... 提交逻辑
}
```

**b. 错误信息智能识别**
```javascript
// 特殊错误处理 - 识别数据库重复约束错误
if (errorMsg.includes('已存在') || errorMsg.includes('重复') ||
    errorMsg.includes('Duplicate') || errorMsg.includes('uniq_user_property')) {
  errorMsg = '您已提交过该房产的认证申请,请勿重复提交';
} else if (errorMsg.includes('SQLIntegrityConstraintViolationException')) {
  errorMsg = '该房产已提交认证,请勿重复提交';
}
```

---

### 2. Controller 层优化（前置检查）

**文件位置：** [ruoyi-user/src/main/java/com/ruoyi/user/controller/AppPropertyController.java](ruoyi-user/src/main/java/com/ruoyi/user/controller/AppPropertyController.java)

#### 改进策略：
在数据插入之前，先查询数据库进行两项检查：
1. 检查当前用户是否已提交过该房产
2. **新增**：检查该房产是否已被其他用户绑定

```java
@PostMapping("/user-property/add")
public AjaxResult addUserProperty(@RequestBody EstateUserProperty estateUserProperty) {
    // 1. 验证房产是否存在
    EstateProperty property = estatePropertyService.selectEstatePropertyByPropertyId(
        estateUserProperty.getPropertyId()
    );
    if (property == null) {
        return AjaxResult.error("提交失败，选择的房产不存在");
    }

    Long currentUserId = SecurityUtils.getUserId();

    // 2. 检查当前用户是否已经提交过该房产的认证申请
    EstateUserProperty userQuery = new EstateUserProperty();
    userQuery.setUserId(currentUserId);
    userQuery.setPropertyId(estateUserProperty.getPropertyId());
    List<EstateUserProperty> userExistingList =
        estateUserPropertyService.selectEstateUserPropertyList(userQuery);

    if (userExistingList != null && !userExistingList.isEmpty()) {
        return AjaxResult.error("您已提交过该房产的认证申请，请勿重复提交");
    }

    // 3. 【新增】检查该房产是否已被其他用户绑定（审核通过的记录）
    EstateUserProperty propertyQuery = new EstateUserProperty();
    propertyQuery.setPropertyId(estateUserProperty.getPropertyId());
    propertyQuery.setStatus("1"); // 1-审核通过
    List<EstateUserProperty> propertyExistingList =
        estateUserPropertyService.selectEstateUserPropertyList(propertyQuery);

    if (propertyExistingList != null && !propertyExistingList.isEmpty()) {
        // 获取房产地址信息用于提示
        String roomInfo = property.getBuildingName() + property.getUnitName() + property.getRoomNumber();
        return AjaxResult.error("该房产(" + roomInfo + ")已被其他用户绑定，如有疑问请联系物业管理处");
    }

    // 4. 执行插入操作
    estateUserProperty.setUserId(currentUserId);
    estateUserProperty.setCommunityId(property.getCommunityId());
    estateUserProperty.setStatus("0"); // 0-待审核
    return toAjax(estateUserPropertyService.insertEstateUserProperty(estateUserProperty));
}
```

**优势：**
- ✅ 提前拦截重复请求，减少不必要的数据库操作
- ✅ 返回友好的业务错误信息（包含房产地址）
- ✅ 避免触发数据库约束异常
- ✅ **新增**：防止多个用户绑定同一房产

---

### 3. Service 层优化（异常捕获）

**文件位置：** [ruoyi-system/src/main/java/com/ruoyi/system/service/impl/EstateUserPropertyServiceImpl.java](ruoyi-system/src/main/java/com/ruoyi/system/service/impl/EstateUserPropertyServiceImpl.java)

#### 改进策略：
即使 Controller 层检查通过，在并发场景下仍可能触发数据库约束。Service 层作为最后一道防线，捕获并转换数据库异常。

```java
@Override
public int insertEstateUserProperty(EstateUserProperty estateUserProperty) {
    estateUserProperty.setCreateTime(DateUtils.getNowDate());
    estateUserProperty.setCreateBy(SecurityUtils.getUsername());

    try {
        return estateUserPropertyMapper.insertEstateUserProperty(estateUserProperty);
    } catch (Exception e) {
        // 捕获数据库唯一索引约束异常
        if (e.getMessage() != null &&
            (e.getMessage().contains("Duplicate entry") ||
             e.getMessage().contains("uniq_user_property"))) {
            throw new ServiceException("您已提交过该房产的认证申请，请勿重复提交");
        }
        // 其他异常继续抛出
        throw e;
    }
}
```

**优势：**
- ✅ 处理并发场景下的重复提交
- ✅ 将数据库技术异常转换为业务异常
- ✅ 保护系统内部实现细节不被暴露

---

## 验证测试

### 测试场景 1：正常提交流程
**步骤：**
1. 登录系统
2. 进入产权认证页面
3. 填写完整的认证信息
4. 点击"提交审核"按钮

**预期结果：**
- ✅ 显示"提交中..."加载提示
- ✅ 提交成功后显示"提交成功,请等待审核"
- ✅ 2秒后自动返回上一页
- ✅ 数据成功保存到数据库

---

### 测试场景 2：重复提交相同房产（前端防护）
**步骤：**
1. 登录系统
2. 进入产权认证页面
3. 填写认证信息
4. **快速连续点击**"提交审核"按钮多次

**预期结果：**
- ✅ 第一次点击：正常提交
- ✅ 后续点击：显示"正在提交中,请勿重复操作"
- ✅ 不会产生多条数据库记录

---

### 测试场景 3：提交已认证的房产（Controller 层防护）
**步骤：**
1. 确认数据库中已存在用户对某房产的认证记录
2. 登录同一用户账号
3. 再次提交该房产的认证申请

**预期结果：**
- ✅ 提交失败
- ✅ 显示模态框错误提示："您已提交过该房产的认证申请，请勿重复提交"
- ✅ 数据库中不会产生新记录

---

### 测试场景 4：房产已被其他用户绑定（Controller 层防护）
**步骤：**
1. 用户A登录系统并提交某房产认证
2. 管理员审核通过用户A的申请（status = '1'）
3. 用户B登录系统
4. 用户B尝试提交相同房产的认证申请

**预期结果：**
- ✅ 用户B的提交被拦截
- ✅ 显示模态框错误提示："该房产(XX栋XX单元XX号)已被其他用户绑定，如有疑问请联系物业管理处"
- ✅ 提示信息中包含具体的房产地址
- ✅ 数据库中不会产生新记录

---

### 测试场景 5：并发提交（Service 层防护）
**步骤：**
1. 使用测试工具（如 Postman）
2. 同时发送多个相同的提交请求
3. 观察返回结果和数据库记录

**预期结果：**
- ✅ 只有一个请求成功
- ✅ 其他请求返回："您已提交过该房产的认证申请，请勿重复提交"
- ✅ 数据库中只有一条记录

---

### 测试场景 6：错误信息友好性验证
**步骤：**
1. 尝试各种方式触发重复提交
2. 观察错误提示内容

**预期结果：**
- ✅ 不再显示数据库技术错误信息
- ✅ 显示用户友好的中文提示
- ✅ 错误信息清晰说明问题原因

---

## 数据库验证

### 查询用户的房产认证记录
```sql
-- 查看指定用户的所有房产认证记录
SELECT
    association_id,
    user_id,
    property_id,
    community_id,
    user_type,
    status,
    create_time
FROM sys_estate_user_property
WHERE user_id = 118
ORDER BY create_time DESC;
```

### 验证唯一索引约束
```sql
-- 查看表的索引信息
SHOW INDEX FROM sys_estate_user_property;

-- 应该能看到 uniq_user_property 唯一索引
-- 该索引组合了 user_id 和 property_id 字段
```

### 清理测试数据（如需要）
```sql
-- 删除测试用户的房产认证记录（谨慎操作！）
DELETE FROM sys_estate_user_property
WHERE user_id = 118 AND property_id = 1000;
```

---

## 回归测试清单

在修复后，请确保以下功能仍然正常：

- [ ] 首次提交房产认证 - 应该成功
- [ ] 提交不存在的房产 - 应该提示"房产不存在"
- [ ] 图片上传功能 - 应该正常上传
- [ ] 表单验证 - 各项必填验证正常
- [ ] 提交成功后返回 - 应该自动跳转
- [ ] 重复提交拦截 - 应该友好提示
- [ ] 审核通过后的数据同步 - 应该正常

---

## 性能影响分析

### Controller 层前置检查的性能影响

**额外操作：**
```java
List<EstateUserProperty> existingList =
    estateUserPropertyService.selectEstateUserPropertyList(query);
```

**性能评估：**
- 查询条件：`user_id` + `property_id`（有索引支持）
- 查询结果：最多1条记录
- 性能开销：< 10ms（正常情况）
- **结论**：性能影响微乎其微，换来的是更好的用户体验

---

## 监控建议

### 日志记录
建议在以下位置添加日志：

```java
// Controller 层
if (existingList != null && !existingList.isEmpty()) {
    logger.warn("用户 {} 尝试重复提交房产 {} 的认证申请", currentUserId, estateUserProperty.getPropertyId());
    return AjaxResult.error("您已提交过该房产的认证申请，请勿重复提交");
}

// Service 层
catch (Exception e) {
    if (e.getMessage() != null && e.getMessage().contains("Duplicate entry")) {
        logger.error("数据库唯一索引冲突：userId={}, propertyId={}",
            estateUserProperty.getUserId(),
            estateUserProperty.getPropertyId());
        throw new ServiceException("您已提交过该房产的认证申请，请勿重复提交");
    }
}
```

---

## 总结

### 修复效果
- ✅ **技术错误不再暴露**：数据库约束异常被正确捕获和转换
- ✅ **用户体验提升**：显示友好的中文错误提示（包含房产地址信息）
- ✅ **系统健壮性增强**：三层防护机制确保数据一致性
- ✅ **业务规则完善**：防止一个房产被多个用户绑定
- ✅ **性能影响可控**：前置检查性能开销微小

### 修改文件
1. ✅ `ruoyi-app/pageB/property/add.vue` - 前端防护 + 错误信息优化
2. ✅ `ruoyi-user/.../AppPropertyController.java` - Controller 层双重检查（用户重复 + 房产已绑定）
3. ✅ `ruoyi-system/.../EstateUserPropertyServiceImpl.java` - Service 层异常处理

### 测试要点
- ✅ 正常提交流程
- ✅ 快速连续点击（前端防护）
- ✅ 重复提交已认证房产（Controller 防护 - 场景1）
- ✅ **新增**：提交已被其他用户绑定的房产（Controller 防护 - 场景2）
- ✅ 并发提交场景（Service 防护）
- ✅ 错误提示友好性（包含房产地址）

### 业务规则说明
1. **用户维度**：同一用户不能重复提交同一房产的认证申请
2. **房产维度**：一个房产只能被一个用户绑定（审核通过状态）
3. **待审核状态**：允许多个用户同时提交同一房产的认证申请（等待管理员审核决定）
4. **审核通过后**：房产与用户绑定，其他用户无法再提交该房产的认证

---

## 错误提示对照表

| 场景 | 原错误信息 | 新错误提示 |
|-----|-----------|-----------|
| 用户重复提交 | `Duplicate entry '118-1000' for key 'uniq_user_property'` | `您已提交过该房产的认证申请，请勿重复提交` |
| 房产已被绑定 | 无检查，可能成功插入或出错 | `该房产(XX栋XX单元XX号)已被其他用户绑定，如有疑问请联系物业管理处` |
| 快速重复点击 | 可能重复提交 | `正在提交中,请勿重复操作` |
| 网络错误 | 技术错误信息 | `网络连接失败,请检查网络后重试` |

---

**修复完成！现在用户再次尝试重复提交或绑定已被占用的房产时，将会看到友好的提示信息，而不是难以理解的数据库错误。**
